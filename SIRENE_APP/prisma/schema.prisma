// Schema do Banco de Dados - Sistema Corpo de Bombeiros
// Versão: 1.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Tabela: Militar
model Militar {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  nome         String?
  matricula    String?  @unique
  cpf          String?
  numeroMilitar String?
  posto        String?
  email        String?
  senhaHash    String?  @map("senha_hash")
  perfilAcesso String?  @map("perfil_acesso")

  // Relacionamentos
  equipesLideradas    Equipe[]           @relation("EquipeLider")
  militarEquipes      MilitarEquipe[]
  registrosOcorrencia RegistroOcorrencia[]
  logsAuditoria       LogAuditoria[]
  relatorios          Relatorio[]

  @@map("Militar")
}

// Tabela: Equipe
model Equipe {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  nomeEquipe       String?  @map("nome_equipe")
  turno            String?
  idMilitarLider   String?  @db.ObjectId

  // Relacionamentos
  lider               Militar?            @relation("EquipeLider", fields: [idMilitarLider], references: [id])
  militarEquipes      MilitarEquipe[]
  registrosOcorrencia RegistroOcorrencia[]

  @@map("Equipe")
}

// Tabela: Ocorrencia
model Ocorrencia {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  dataHora          DateTime? @map("data_hora")
  tipoOcorrencia    String?   @map("tipo_ocorrencia")
  descricao         String?
  endereco          String?   @map("endereco")
  numero            String?   @map("numero")
  regiao            String?   @map("regiao")
  cidade            String?
  bairro            String?          
  localizacaoGps    String?   @map("localizacao_gps")
  pontoReferencia   String?   @map("ponto_referencia")
  prioridade        String?   @map("prioridade")
  status            String?
  assinaturaDigital String?   @map("assinatura_digital")
  fotoUrl           String?   @map("foto_url")
  videoUrl          String?   @map("video_url")

  // Relacionamentos
  registrosOcorrencia RegistroOcorrencia[]
  relatorios          Relatorio[]

  @@map("Ocorrencia")
}

// Tabela: RegistroOcorrencia
model RegistroOcorrencia {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia   String?   @db.ObjectId
  idMilitar      String?   @db.ObjectId
  idEquipe       String?   @db.ObjectId
  dataRegistro   DateTime? @map("data_registro")
  observacoes    String?

  // Relacionamentos
  ocorrencia Ocorrencia? @relation(fields: [idOcorrencia], references: [id])
  militar    Militar?    @relation(fields: [idMilitar], references: [id])
  equipe     Equipe?     @relation(fields: [idEquipe], references: [id])

  @@map("RegistroOcorrencia")
}

// Tabela: LogAuditoria
model LogAuditoria {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  idMilitar  String?   @db.ObjectId
  acao       String?
  dataHora   DateTime? @map("data_hora")
  ipOrigem   String?   @map("ip_origem")

  // Relacionamentos
  militar Militar? @relation(fields: [idMilitar], references: [id])

  @@map("LogAuditoria")
}

// Tabela: Relatorio
model Relatorio {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?   @db.ObjectId
  geradoPor    String?   @db.ObjectId
  dataGeracao  DateTime? @map("data_geracao")
  formato      String?
  urlArquivo   String?

  // Relacionamentos
  ocorrencia Ocorrencia? @relation(fields: [idOcorrencia], references: [id])
  militar    Militar?    @relation(fields: [geradoPor], references: [id])

  @@map("Relatorio")
}

// Tabela de Junção: MilitarEquipe
model MilitarEquipe {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  idMilitar  String @db.ObjectId
  idEquipe   String @db.ObjectId

  // Relacionamentos
  militar Militar @relation(fields: [idMilitar], references: [id])
  equipe  Equipe  @relation(fields: [idEquipe], references: [id])

  @@map("MilitarEquipe")
}

// Formulários de atendimento (cada tipo em sua própria coleção)
// 1) BÁSICO
model FormularioBasico {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId
  
  // Campos do Formulário Básico
  pontoBase             String?
  ome                   String?
  viaturaResponsavel    String?
  numeroAviso           String?
  data                  DateTime?
  horaRecebimento       DateTime?
  formaAcionamento      String?
  formaAcionamentoOutros String?
  situacaoOcorrencia    String?
  situacaoOcorrenciaOutros String?
  localAcionamento      String?
  localAcionamentoOutros String?
  areaOBM               Boolean?
  codigoLocal           String?
  referencia            String?
  solicitanteNome       String?
  solicitanteTelefone   String?
  deslocamento          Json?      
  viaturaLocal          String?
  placaViaturaLocal     String?
  apoio                 String?
  viaturasEnvolvidas    Json?     
  historico             String?
  continuacao           Boolean?
  dificuldadesAtuacao   String?
  eventoNatureza        String?
  formulariosPreenchidos String?
  tipoVitima            String?
  veiculosEnvolvidos    Json?
  guarnicaoEmpenhada    Json?
  vistoDivisaoOperacoes String?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  // relação mantida pelo id (idOcorrencia) sem constraint Prisma para evitar necessidade de campo inverso
  @@map("FormularioBasico")
}

// 2) PRÉ-HOSPITALAR - CVI
model FormularioPreHospital {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId
  // Campos explícitos extraídos do frontend (forms1..5)
  pontoBase        String?
  ome              String?
  viaturaDestino   String?
  numeroAviso      String?
  latitude         String?
  longitude        String?
  elevacao         String?
  numeroGps        String?
  areaCBM          String?
  areaCBM_vazio    String?
  motivoAreaVazio  String?
  fotos            Json?
  videos           Json?

  // Identificação e horários
  assinaturaDigital String?
  idade             Int?
  sexo              String?
  documentoPessoa   String?
  tipoAcidente      String?
  tempoCenaMin      Int?
  atrasoInternoMin  Int?
  horarioSaida      String?
  horarioNoLocal    String?
  horarioChegadaHosp String?
  horarioFinalizacao String?
  ctfLocal          String?
  ctfVtrLocal       String?
  numeroDespachante String?

  // Vítimas / evento
  atendimentoDescricao String?
  eventoNatureza       String?
  tipoVitima           String?
  gravidadeVitima      String?
  prioridadeVitima     String?

  // Veículos / guarnição
  veiculos            Json?
  guarnicao           Json?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  // relação mantida pelo id (idOcorrencia) sem constraint Prisma
  @@map("FormularioPreHospital")
}

// 3) INCÊNDIO
model FormularioIncendio {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId
  // Campos explícitos do fluxo Incêndio
  localIncendio      String?
  enderecoComplemento String?
  tipoIncendio       String?
  houveDanos         String?
  numeroVitimas      Int?
  materialCombustao  String?
  areaAtingidaM2     Int?
  latitude           String?
  longitude          String?
  tipoAgua           String?
  resgateVitimas     String?
  tempoCombateMin    Int?
  aguaUtilizadaLitros Int?
  fotos              Json?
  videos             Json?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  // relação mantida pelo id (idOcorrencia) sem constraint Prisma
  @@map("FormularioIncendio")
}

// 4) SALVAMENTO
model FormularioSalvamento {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId
  // Campos explícitos do fluxo Salvamento
  pontoBase        String?
  qgObm            String?
  tipoVtr          String?
  numeroAviso      String?
  diaHora          String?
  logradouro       String?
  numeroLogradouro String?
  bairro           String?
  municipioUf      String?
  latitude         String?
  longitude        String?
  areaOBM          String?
  codigoLocal      String?
  fotos            Json?
  videos           Json?
  descricaoAtendimento String?
  observacoes      String?
  veiculos         Json?
  guarnicao        Json?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  // relação mantida pelo id (idOcorrencia) sem constraint Prisma
  @@map("FormularioSalvamento")
}

// 5) PRODUTOS PERIGOSOS
model FormularioProdutosPerigosos {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId
  // Campos explícitos para Produtos Perigosos
  pontoBase        String?
  cme              String?
  tipoVtr          String?
  numeroAviso      String?
  diaHora          String?
  descricaoRisco   String?
  material         String?
  quantidade       String?
  riscoPrincipal   String?
  medidasAdotadas  String?
  fotos            Json?
  videos           Json?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  // relação mantida pelo id (idOcorrencia) sem constraint Prisma
  @@map("FormularioProdutosPerigosos")
}

// 6) PREVENÇÃO
model FormularioPrevencao {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  idOcorrencia String?  @db.ObjectId

  // Campos do fluxo Prevencao (forms1..5)
  pontoBase        String?
  cme              String?
  tipoVtr          String?
  numeroAviso      String?
  diaHora          String?
  formaAcionamento String?
  situacaoOcorrencia String?
  localAcionamento  String?
  logradouro       String?
  numeroLogradouro String?
  bairro           String?
  municipioUf      String?
  latitude         String?
  longitude        String?
  fotos            Json?
  videos           Json?
  observacoes      String?

  dados        Json?
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime? @map("atualizado_em")

  @@map("FormularioPrevencao")
}
